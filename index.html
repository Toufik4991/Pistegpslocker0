<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saumur Quest - Master Engine</title>
    <style>
        :root { 
            --gold: #fbc02d; --bg: #0a0a0a; --blue: #00d4ff; 
            --green: #00ff41; --orange: #ff8c00; --red: #ff0000; 
        }
        
        body { 
            background: var(--bg); color: white; font-family: -apple-system, sans-serif; 
            margin: 0; overflow: hidden; height: 100vh; 
        }

        #nav-halo {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            border: 0px solid transparent; transition: border-color 0.6s, border-width 0.3s;
            pointer-events: none; z-index: 5000; box-sizing: border-box;
        }

        #compass-container {
            width: 120px; height: 120px; border: 2px solid var(--gold);
            border-radius: 50%; position: relative; margin: 20px auto;
            background: rgba(255,255,255,0.05);
        }
        #needle {
            width: 4px; height: 55px; background: var(--gold);
            position: absolute; left: 50%; top: 10%; transform-origin: bottom center;
            transition: transform 0.2s ease-out; border-radius: 2px;
        }

        #profile-btn {
            position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
            background: rgba(30, 30, 30, 0.9); border: 2px solid var(--gold);
            border-radius: 50%; z-index: 9000; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        #dashboard {
            position: fixed; top: 0; right: -100%; width: 280px; height: 100vh;
            background: rgba(10, 10, 10, 0.98); border-left: 2px solid var(--gold);
            z-index: 8500; transition: 0.4s; padding: 80px 25px; box-sizing: border-box;
        }
        #dashboard.open { right: 0; }

        .stat-item { margin-bottom: 25px; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 1.4rem; color: var(--gold); font-weight: bold; display: block; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 20px; box-sizing: border-box; text-align: center; 
        }
        #game-screen { z-index: 6000; background: var(--bg); display: none; overflow-y: auto; }

        .btn { 
            background: var(--gold); color: black; border: none; padding: 15px 30px; 
            border-radius: 30px; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        input { 
            background: #1a1a1a; border: 1px solid var(--gold); color: white; padding: 12px; 
            border-radius: 10px; text-align: center; width: 80%; margin-bottom: 20px; 
        }

        @keyframes spin { 100% { transform: translateX(-50%) rotate(360deg); } }
        .blinking { animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="nav-halo"></div>
    <div id="profile-btn" onclick="toggleDashboard()">ðŸ‘¤</div>

    <div id="dashboard">
        <div class="stat-item"><span class="stat-label">Joueur</span><span class="stat-val" id="dash-name">---</span></div>
        <div class="stat-item"><span class="stat-label">Chrono Marche</span><span class="stat-val" id="dash-chrono">00:00</span></div>
        <div class="stat-item"><span class="stat-label">Points</span><span class="stat-val" id="dash-score">0</span></div>
        <div class="stat-item"><span class="stat-label">Ã‰tape</span><span class="stat-val" id="dash-step">1 / 9</span></div>
        <button class="btn" style="background:#333; color:red; font-size:0.6rem;" onclick="resetGame()">RÃ©initialiser</button>
    </div>

    <div id="setup-screen" class="screen">
        <h1 style="color: var(--gold)">SAUMUR QUEST</h1>
        <div id="new-game-box">
            <input type="text" id="player-name" placeholder="Ton Pseudo...">
            <button class="btn" onclick="initNewGame()">Commencer</button>
        </div>
        <div id="resume-box" style="display:none;">
            <p style="color: var(--green)">Aventure en cours...</p>
            <button class="btn" onclick="resumeGame()">Reprendre</button>
        </div>
    </div>

    <div id="nav-screen" class="screen" style="z-index:4000;">
        <h2 id="nav-msg">GPS Initialisation...</h2>
        <div id="compass-container">
            <div id="needle"></div>
        </div>
        <div id="radar-dist" style="font-size: 3rem; font-weight: 900;">---</div>
        <div id="zone-action-btn" style="display:none; margin-top:20px;">
            <button class="btn" onclick="launchGame()">Lancer le DÃ©fi</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-inject" style="width:100%;"></div>
    </div>

<script>
    const GPS = [
        { lat: 47.25865295634987, lon: -0.07232092747517298 },
        { lat: 47.25922301993599, lon: -0.07496422077580976 },
        { lat: 47.25957512835827, lon: -0.07585838017127501 },
        { lat: 47.25855640527987, lon: -0.07438732146623522 },
        { lat: 47.25777300506129, lon: -0.07572423946778357 },
        { lat: 47.257047880177915, lon: -0.07570440178130702 },
        { lat: 47.2566497660443, lon: -0.0740386275036121 },
        { lat: 47.253662326392785, lon: -0.07059828273820297 },
        { lat: 47.25564998079592, lon: -0.068996433977779 }
    ];

    let playerName = "", currentStep = 0, score = 0, marchTimer = 0, timerActive = false;

    window.onload = () => {
        if (localStorage.getItem('saumur_v2_final')) {
            document.getElementById('new-game-box').style.display = 'none';
            document.getElementById('resume-box').style.display = 'block';
        }
    };

    function saveState() {
        localStorage.setItem('saumur_v2_final', JSON.stringify({playerName, currentStep, score, marchTimer}));
    }

    function initNewGame() {
        playerName = document.getElementById('player-name').value || "Explorateur";
        saveState();
        startGame();
    }

    function resumeGame() {
        const s = JSON.parse(localStorage.getItem('saumur_v2_final'));
        playerName = s.playerName; currentStep = s.currentStep; score = s.score; marchTimer = s.marchTimer;
        startGame();
    }

    function startGame() {
        document.getElementById('dash-name').innerText = playerName;
        document.getElementById('setup-screen').style.display = 'none';
        navigator.geolocation.watchPosition(updateGPS, null, { enableHighAccuracy: true });
        setInterval(() => { if(timerActive){ marchTimer++; updateUI(); if(marchTimer%10==0)saveState(); } }, 1000);
    }

    function updateUI() {
        const m = Math.floor(marchTimer/60).toString().padStart(2,'0');
        const s = (marchTimer%60).toString().padStart(2,'0');
        document.getElementById('dash-chrono').innerText = `${m}:${s}`;
        document.getElementById('dash-step').innerText = `${currentStep + 1} / 9`;
        document.getElementById('dash-score').innerText = score;
    }

    function updateGPS(pos) {
        const target = GPS[currentStep];
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        const dist = calculateDistance(lat, lon, target.lat, target.lon);
        
        const angle = Math.atan2(target.lon - lon, target.lat - lat) * (180 / Math.PI);
        const needle = document.getElementById('needle');
        if (dist < 35) {
            needle.style.animation = "spin 0.6s linear infinite";
        } else {
            needle.style.animation = "none";
            const jitter = dist > 100 ? (Math.random()*30-15) : (Math.random()*10-5);
            needle.style.transform = `translateX(-50%) rotate(${angle + jitter}deg)`;
        }

        document.getElementById('radar-dist').innerText = Math.round(dist) + "m";
        updateHalo(dist);
    }

    function updateHalo(dist) {
        const h = document.getElementById('nav-halo');
        const btn = document.getElementById('zone-action-btn');
        const msg = document.getElementById('nav-msg');
        h.style.borderWidth = "20px";
        
        if(dist > 100) { h.style.borderColor = "var(--red)"; msg.innerText = "Loin..."; timerActive = true; btn.style.display='none'; }
        else if(dist > 35) { h.style.borderColor = "var(--orange)"; msg.innerText = "Approche..."; timerActive = true; btn.style.display='none'; h.classList.add('blinking'); }
        else if(dist > 12) { h.style.borderColor = "var(--green)"; msg.innerText = "ZONE ATTEINTE"; timerActive = false; btn.style.display='block'; h.classList.remove('blinking'); }
        else { h.style.borderColor = "var(--blue)"; msg.innerText = "SUR LA CIBLE"; timerActive = false; btn.style.display='block'; }
    }

    function calculateDistance(la1, lo1, la2, lo2) {
        const R = 6371000;
        const dLat = (la2-la1)*Math.PI/180; const dLon = (lo2-lo1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function launchGame() {
        document.getElementById('game-screen').style.display = 'flex';
        const box = document.getElementById('game-inject');
        window["CODEJEUX" + (currentStep + 1)](box);
    }

    function validateStep(pts) {
        score += pts; currentStep++; saveState();
        document.getElementById('game-screen').style.display = 'none';
        updateUI();
        if(currentStep >= 9) alert("BRAVO ! Vous avez fini le parcours.");
    }

    // --- ZONE DES JEUX (PROPRE) ---

    function CODEJEUX1(p) {
        const sequenceCorrecte = [0, 2, 8, 6]; 
        let sequenceJoueur = [];

        p.innerHTML = `
            <div style="background: rgba(20,20,20,0.95); padding: 25px; border: 2px solid var(--gold); border-radius: 20px;">
                <h2 style="color: var(--gold); margin: 0 0 10px 0;">INITIALISATION</h2>
                <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 20px;">Reproduisez le motif lumineux.</p>
                <div id="grid-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 0 auto 20px; width: 210px;">
                    ${[0,1,2,3,4,5,6,7,8].map(i => `
                        <div id="node-${i}" onclick="touchNode(${i})" style="width: 60px; height: 60px; border: 2px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; cursor: pointer; background: rgba(255,255,255,0.02);">
                            <div style="width: 8px; height: 8px; background: #444; border-radius: 50%;"></div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="montrerSequence()" style="background: none; border: 1px solid var(--gold); color: var(--gold); font-size: 0.7rem; padding: 10px; width: 100%;">REVOIR LE MOTIF</button>
                <p id="feedback-1" style="margin-top: 15px; font-weight: bold; min-height: 1.2rem; font-size: 0.9rem;"></p>
            </div>
        `;

        function flashNode(id, color, duration = 500) {
            const node = document.getElementById('node-' + id);
            if(!node) return;
            node.style.borderColor = color;
            node.style.boxShadow = '0 0 15px ' + color;
            setTimeout(() => { node.style.borderColor = "#333"; node.style.boxShadow = "none"; }, duration);
        }

        window.montrerSequence = function() {
            sequenceJoueur = [];
            document.getElementById('feedback-1').innerText = "OBSERVEZ...";
            sequenceCorrecte.forEach((nodeId, index) => {
                setTimeout(() => flashNode(nodeId, "var(--gold)"), (index + 1) * 600);
            });
        };

        window.touchNode = function(id) {
            flashNode(id, "var(--blue)", 300);
            sequenceJoueur.push(id);
            if (sequenceJoueur[sequenceJoueur.length - 1] !== sequenceCorrecte[sequenceJoueur.length - 1]) {
                document.getElementById('feedback-1').innerText = "âŒ ERREUR";
                sequenceJoueur = [];
                return;
            }
            if (sequenceJoueur.length === sequenceCorrecte.length) {
                document.getElementById('feedback-1').innerText = "âœ… RÃ‰USSI";
                setTimeout(() => validateStep(100), 1000);
            }
        };
        setTimeout(montrerSequence, 1000);
    }

    function CODEJEUX2(p) { p.innerHTML = "<h2>DÃ‰FI 2</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX3(p) { p.innerHTML = "<h2>DÃ‰FI 3</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX4(p) { p.innerHTML = "<h2>DÃ‰FI 4</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX5(p) { p.innerHTML = "<h2>DÃ‰FI 5</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX6(p) { p.innerHTML = "<h2>DÃ‰FI 6</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX7(p) { p.innerHTML = "<h2>DÃ‰FI 7</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX8(p) { p.innerHTML = "<h2>DÃ‰FI 8</h2><button class='btn' onclick='validateStep(100)'>Terminer</button>"; }
    function CODEJEUX9(p) { p.innerHTML = "<h2>DÃ‰FI FINAL</h2><button class='btn' onclick='validateStep(100)'>Podium</button>"; }

    function toggleDashboard() { document.getElementById('dashboard').classList.toggle('open'); }
    function resetGame() { localStorage.removeItem('saumur_v2_final'); location.reload(); }
</script>
</body>
</html>
