<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saumur Quest - Final Engine</title>
    <style>
        :root { 
            --gold: #fbc02d; --bg: #0a0a0a; --blue: #00d4ff; 
            --green: #00ff41; --orange: #ff8c00; --red: #ff0000; 
        }
        
        body { 
            background: var(--bg); color: white; font-family: -apple-system, sans-serif; 
            margin: 0; overflow: hidden; height: 100vh; 
        }

        /* --- INTERFACE DE BORDURE --- */
        #nav-halo {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            border: 0px solid transparent; transition: border-color 0.6s, border-width 0.3s;
            pointer-events: none; z-index: 5000; box-sizing: border-box;
        }

        /* --- BOUTONS HAUT DROITE --- */
        .top-ui-container {
            position: fixed; top: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 15px; z-index: 9000;
            align-items: center;
        }

        #profile-btn {
            width: 50px; height: 50px; background: rgba(30, 30, 30, 0.9);
            border: 2px solid var(--gold); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        /* --- LA BOUSSOLE MINI/MAXI --- */
        #compass-container {
            width: 60px; height: 60px; border: 2px solid var(--gold);
            border-radius: 50%; background: rgba(0,0,0,0.8);
            position: relative; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; overflow: hidden;
        }

        #compass-container.zoom {
            width: 200px; height: 200px;
            position: fixed; top: 50%; right: 50%;
            transform: translate(50%, -50%);
            box-shadow: 0 0 50px rgba(251, 192, 45, 0.5);
        }

        #needle {
            width: 3px; height: 45%; background: var(--gold);
            position: absolute; left: 50%; top: 5%; transform-origin: bottom center;
            transition: transform 0.2s ease-out; border-radius: 2px;
        }

        /* --- √âCRANS --- */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 20px; box-sizing: border-box; text-align: center; 
        }
        #game-screen { z-index: 9500; background: rgba(10,10,10,0.95); display: none; }

        /* --- DASHBOARD --- */
        #dashboard {
            position: fixed; top: 0; right: -100%; width: 280px; height: 100vh;
            background: rgba(10, 10, 10, 0.98); border-left: 2px solid var(--gold);
            z-index: 8500; transition: 0.4s; padding: 80px 25px; box-sizing: border-box;
        }
        #dashboard.open { right: 0; }

        /* --- STYLES GENERAUX --- */
        .btn { background: var(--gold); color: black; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; text-transform: uppercase; }
        @keyframes spin { 100% { transform: translateX(-50%) rotate(360deg); } }
    </style>
</head>
<body>

    <div id="nav-halo"></div>

    <div class="top-ui-container">
        <div id="profile-btn" onclick="toggleDashboard()">üë§</div>
        <div id="compass-container" onclick="toggleCompass()">
            <div id="needle"></div>
        </div>
    </div>

    <div id="dashboard">
        <h3 style="color:var(--gold)">STATS</h3>
        <div id="dash-name" style="font-weight:bold; margin-bottom:10px;">---</div>
        <div id="dash-chrono">00:00</div>
        <div id="dash-step">√âtape 1/9</div>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <button onclick="resetGame()" style="color:red; background:none; border:none;">R√©initialiser</button>
    </div>

    <div id="setup-screen" class="screen">
        <h1 style="color: var(--gold)">SAUMUR QUEST</h1>
        <div id="new-game-box">
            <input type="text" id="player-name" placeholder="Pseudo..." style="padding:10px; border-radius:10px; margin-bottom:10px;">
            <br>
            <button class="btn" onclick="initNewGame()">Commencer</button>
        </div>
    </div>

    <div id="nav-screen" class="screen">
        <h2 id="nav-msg" onclick="checkDebug()">Initialisation GPS...</h2>
        <div id="radar-dist" style="font-size: 4rem; font-weight: 900;">---</div>
        <div id="zone-action-btn" style="display:none; margin-top:20px;">
            <button class="btn" onclick="launchGame()">Lancer le D√©fi</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-inject" style="width:100%;"></div>
    </div>

<script>
    // ==========================================
    // ‚öôÔ∏è CONFIGURATION & VARIABLES
    // ==========================================
    const GPS = [
        { lat: 47.258652, lon: -0.072320 }, // Step 1
        { lat: 47.259223, lon: -0.074964 }  // Step 2... etc
    ];

    let playerName = "", currentStep = 0, marchTimer = 0, timerActive = false;
    let debugClicks = 0;

    // ==========================================
    // üõ∞Ô∏è LOGIQUE GPS & NAVIGATION
    // ==========================================
    function initNewGame() {
        playerName = document.getElementById('player-name').value || "Explorateur";
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('dash-name').innerText = playerName;
        navigator.geolocation.watchPosition(updateGPS, null, { enableHighAccuracy: true });
    }

    function updateGPS(pos) {
        const target = GPS[currentStep];
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        const dist = calculateDistance(lat, lon, target.lat, target.lon);
        
        // Mise √† jour visuelle boussole
        const angle = Math.atan2(target.lon - lon, target.lat - lat) * (180 / Math.PI);
        const needle = document.getElementById('needle');
        
        if (dist < 35) {
            needle.style.animation = "spin 0.6s linear infinite";
        } else {
            needle.style.animation = "none";
            const jitter = dist > 100 ? (Math.random()*30-15) : (Math.random()*10-5);
            needle.style.transform = `translateX(-50%) rotate(${angle + jitter}deg)`;
        }

        document.getElementById('radar-dist').innerText = Math.round(dist) + "m";
        updateHalo(dist);
    }

    function updateHalo(dist) {
        const h = document.getElementById('nav-halo');
        const btn = document.getElementById('zone-action-btn');
        const msg = document.getElementById('nav-msg');
        h.style.borderWidth = "20px";
        
        if(dist > 100) { h.style.borderColor = "var(--red)"; msg.innerText = "Cherchez..."; btn.style.display='none'; }
        else if(dist > 35) { h.style.borderColor = "var(--orange)"; msg.innerText = "Approche..."; btn.style.display='none'; }
        else { h.style.borderColor = "var(--green)"; msg.innerText = "ZONE ATTEINTE"; btn.style.display='block'; }
    }

    // ==========================================
    // üéÆ ZONE DES JEUX (TON TRAVAIL)
    // ==========================================
    function CODEJEUX1(p) {
        const sequenceCorrecte = [0, 2, 8, 6]; 
        let sequenceJoueur = [];
        p.innerHTML = `<div style="border:2px solid var(--gold); padding:20px; border-radius:15px;">
            <h3>D√âVERROUILLAGE</h3>
            <div id="grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:20px auto; width:180px;">
                ${[0,1,2,3,4,5,6,7,8].map(i => `<div onclick="touchNode(${i})" id="n-${i}" style="width:50px; height:50px; border:1px solid #444; border-radius:50%;"></div>`).join('')}
            </div>
            <p id="f-1">Observez...</p>
        </div>`;

        window.touchNode = function(id) {
            sequenceJoueur.push(id);
            document.getElementById('n-'+id).style.background = "var(--blue)";
            if(sequenceJoueur.length === 4) { validateStep(100); }
        };
        // Note: J'ai simplifi√© le code ici pour la clart√©, on pourra le rendre plus joli apr√®s !
    }

    // ==========================================
    // üõ†Ô∏è FONCTIONS UTILITAIRES
    // ==========================================
    function toggleCompass() { document.getElementById('compass-container').classList.toggle('zoom'); }
    function toggleDashboard() { document.getElementById('dashboard').classList.toggle('open'); }
    function checkDebug() { debugClicks++; if(debugClicks >= 5) document.getElementById('zone-action-btn').style.display = 'block'; }
    function launchGame() { document.getElementById('game-screen').style.display = 'flex'; CODEJEUX1(document.getElementById('game-inject')); }
    function validateStep(pts) { currentStep++; document.getElementById('game-screen').style.display = 'none'; }
    function calculateDistance(la1, lo1, la2, lo2) {
        const R = 6371000;
        const dLat = (la2-la1)*Math.PI/180; const dLon = (lo2-lo1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function resetGame() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
